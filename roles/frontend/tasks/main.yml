---
- name: Ensure frontend target dir exists
  ansible.builtin.file:
    path: /opt/webapp/frontend/dist
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'

- name: Deploy frontend build (copy static files built in CI)
  ansible.builtin.synchronize:
    src: "{{ playbook_dir }}/../services/frontend/build/"
    dest: /opt/webapp/frontend/dist/
    recursive: yes
    rsync_opts:
      - "--delete"
  delegate_to: localhost

- name: Ensure nginx sites-available directory exists
  ansible.builtin.file:
    path: /etc/nginx/sites-available
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure nginx site config is present
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../roles/nginx/templates/nginx.conf.j2"
    dest: /etc/nginx/sites-available/webapp.conf
  notify:
    - reload nginx

